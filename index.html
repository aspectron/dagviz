<!DOCTYPE html>
<html>
<head>
	<title>BlockDAG Viz</title>
	<link href="https://fonts.googleapis.com/css?family=Exo+2:200|Lato|Open+Sans|Roboto&display=swap" rel="stylesheet">

	<script type="module" src="./components/dag-viz.js"></script>
	<script src="/resources/jquery-3.4.1.js"></script>
	<!--script src="/resources/d3.v5.min.js"></script-->
	
	<script src="/resources/fabric-rpc.js"></script>
	<script src="/resources/underscore-min.js"></script>
	<script src="/resources/blockdag.sample.js"></script>
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<!--script src="https://d3js.org/d3.v3.min.js"></script-->
	<!--script src="/resources/mqttws31.js"></script-->
	<script src="/resources/mqtt.min.js"></script>
	<script type="module" src="./components/app.js"></script>
	<style type="text/css">
		#dagViz{height:100vh;}
		#address { 
			font-family:'Exo 2','Consolas', 'Roboto Mono', 'Open Sans', 'Ubuntu Mono', courier-new, courier, monospace; font-size: 12px;
			position: absolute; right: 8px; top: 8px; color: #666;

		}
		#hud { 
			font-family: 'Consolas', 'Roboto Mono', 'Open Sans', 'Ubuntu Mono', courier-new, courier, monospace; font-size: 14px;
			position: absolute; left: 8px; top: 8px; color: #222;
		}
	</style>
</head>
<body>
	<dag-viz id="dagViz"></dag-viz>
	<div id='address'></div>
	<div id='hud'></div>
	<script type="module">
		import { App } from './components/app.js';
		$(document).ready(()=>{
			window.app = new App();
			//return;
			

			
			let address = app.argv.get('address') || 'ws://finland.aspectron.com:7351';
			$('#address').html(address);
			var client = mqtt.connect(address);
		  	client.subscribe("dag/selected-tip");
			[
				'connect','disconnect','close',
				'reconnect','error','end',
				// 'packetreceive'
			].forEach((op) => {
				client.on(op, (data) => {
					console.log(`[MQTT] ${op}:`,data);
				})
			});

		 
			client.on("message", function (topic, payload) {
			    // console.log([topic, payload].join(": "))
				if(topic == 'dag/selected-tip') {
					try {
						let data = JSON.parse(payload);
						console.log('dag/selected-tip:', data);
						app.onDagSelectedTip(data);
					} catch(ex) {
						console.log('error parsing dag/selected-tip:', ex);
						console.log('payload:', payload);
					}
				}
			});
		})
	</script>
</body>
</html>
